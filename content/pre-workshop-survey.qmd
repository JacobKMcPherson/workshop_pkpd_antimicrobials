---
title: "pre-workshop-survey"
format: html
---

<form id="quiz-form">

<fieldset data-qid="q1" data-answer="Clearance">

<legend>1) Which PK parameter determines how quickly a drug is eliminated from the body?</legend>
<label><input type="radio" name="q1" value="Volume" required> Volume of distribution</label><br>
<label><input type="radio" name="q1" value="Clearance"> Clearance</label><br>
<label><input type="radio" name="q1" value="Bioavailability"> Bioavailability</label><br>
<label><input type="radio" name="q1" value="idk"> I don't know</label>

<p class="feedback" aria-live="polite">

</p>

</fieldset>

<fieldset data-qid="q2" data-answer="Cmax">

<legend>2) Which parameter changes with oral bioavailability (all else equal)?</legend>
<label><input type="radio" name="q2" value="Cmax" required> Cmax</label><br>
<label><input type="radio" name="q2" value="Vd"> Vd</label><br>
<label><input type="radio" name="q2" value="t1/2"> t1/2</label><br>
<label><input type="radio" name="q2" value="idk"> I don't know</label>

<p class="feedback" aria-live="polite">

</p>

</fieldset>

<fieldset data-qid="q3" data-answer="T>MIC">

<legend>3) Which PK/PD index is most important for β-lactam antibiotics?</legend>
<label><input type="radio" name="q3" value="AUC/MIC" required> AUC/MIC</label><br>
<label><input type="radio" name="q3" value="Cmax/MIC"> Cmax/MIC</label><br>
<label><input type="radio" name="q3" value="T>MIC"> Time > MIC (T>MIC)</label><br>
<label><input type="radio" name="q3" value="idk"> I don't know</label>

<p class="feedback" aria-live="polite">

</p>

</fieldset>

<fieldset data-qid="q4" data-answer="400-600">

<legend>4) What is the target AUC/MIC ratio for vancomycin against MRSA?</legend>
<label><input type="radio" name="q4" value="200" required> ≥ 200</label><br>
<label><input type="radio" name="q4" value="400-600"> ≥ 400-600</label><br>
<label><input type="radio" name="q4" value="800"> ≥ 800</label><br>
<label><input type="radio" name="q4" value="idk"> I don't know</label>

<p class="feedback" aria-live="polite">

</p>

</fieldset>

<fieldset data-qid="q5" data-answer="Aminoglycosides">

<legend>5) Which antimicrobial class is primarily concentration-dependent (Cmax/MIC)?</legend>
<label><input type="radio" name="q5" value="Beta-lactams" required> β-lactams</label><br>
<label><input type="radio" name="q5" value="Aminoglycosides"> Aminoglycosides</label><br>
<label><input type="radio" name="q5" value="Macrolides"> Macrolides</label><br>
<label><input type="radio" name="q5" value="idk"> I don't know</label>

<p class="feedback" aria-live="polite">

</p>

</fieldset>

<fieldset data-qid="q6" data-answer="CrCl">

<legend>6) Which patient-specific parameter is most important for adjusting antimicrobial doses?</legend>
<label><input type="radio" name="q6" value="Age" required> Age</label><br>
<label><input type="radio" name="q6" value="Weight"> Weight</label><br>
<label><input type="radio" name="q6" value="CrCl"> Creatinine clearance (CrCl)</label><br>
<label><input type="radio" name="q6" value="idk"> I don't know</label>

<p class="feedback" aria-live="polite">

</p>

</fieldset>

<button type="submit">

Submit

</button>

</form>

<p id="quiz-status" style="margin-top: 10px; font-weight: bold;"></p>

```{=html}
<script>
// Configuration injected during build time
const SUPABASE_URL = "${SUPABASE_URL}";
const SUPABASE_ANON_KEY = "${SUPABASE_ANON_KEY}"; // safe with insert-only policy
const QUIZ_ID = "pk_quiz_v1";

// --- Add this helper to generate/store a unique, anonymous id ---
function getAnonUserId() {
  const localKey = "pk_quiz_user_id";
  let uuid = localStorage.getItem(localKey);
  if (!uuid) {
    uuid = ([1e7]+-1e3+-4e3+-8e3+-1e11)
      .replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    localStorage.setItem(localKey, uuid);
  }
  return uuid;
}

// instant feedback per question (optional)
document.querySelectorAll("fieldset").forEach(fs => {
  fs.addEventListener("change", () => {
    const correct = fs.dataset.answer;
    const chosen = new FormData(document.getElementById("quiz-form")).get(fs.getAttribute("data-qid"));
    const fb = fs.querySelector(".feedback");
    if (!chosen) return;
    //fb.textContent = chosen === correct ? "✅ Correct" : "❌ Try again";
  });
});

document.getElementById("quiz-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;

  // gather answers & compute accuracy
  const fieldsets = [...form.querySelectorAll("fieldset[data-qid]")];
  const details = {};
  let totalCorrect = 0;

  fieldsets.forEach(fs => {
    const qid = fs.dataset.qid;
    const correct = fs.dataset.answer;
    const chosen = new FormData(form).get(qid);
    const isCorrect = chosen === correct;
    details[qid] = { chosen, correct, isCorrect };
    if (isCorrect) totalCorrect++;
  });

  const totalQuestions = fieldsets.length;
  const percent = Math.round((totalCorrect / totalQuestions) * 10000) / 100; // 2 decimals

  // --- Use the anonymized, persistent user id ---
  const user_id = getAnonUserId();

  // POST to Supabase REST
  const payload = {
    quiz_id: QUIZ_ID,
    user_id: user_id, // anonymized & unique per user
    total_questions: totalQuestions,
    total_correct: totalCorrect,
    percent: percent,
    details: {
      ...details,
      meta: {
        ua: navigator.userAgent,
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone
      }
    }
  };

  const res = await fetch(`${SUPABASE_URL}/rest/v1/quiz_responses`, {
    method: "POST",
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json",
      "Prefer": "return=representation"
    },
    body: JSON.stringify(payload)
  });

  const status = document.getElementById("quiz-status");
  if (res.ok) {
    status.textContent = `✅ Recorded. Score: ${totalCorrect}/${totalQuestions} (${percent}%)`;
    form.reset();
    // optional: disable after submit to avoid double-posts
    [...form.elements].forEach(el => el.disabled = true);
  } else {
    status.textContent = "❌ Failed to record. Please try again.";
  }
});
</script>
```

::::: {.d-flex .justify-content-between .border-top .pt-4 .mt-4}
<div>

[← Pre-Workshop Materials](../pre-workshop-materials.qmd){.btn .btn-outline-primary}

</div>

<div>

[Session 1 →](../sessions/session_01/index.qmd){.btn .btn-outline-primary}

</div>
:::::
